<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大文件上传 - 断点续传</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f7f9fc;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .upload-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .file-input-container {
            border: 2px dashed #3498db;
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            background-color: #f0f8ff;
        }
        
        .file-input-container:hover, .file-input-container.dragover {
            background-color: #e6f2ff;
            border-color: #2980b9;
        }
        
        .file-input-container p {
            margin: 0;
            font-size: 18px;
            color: #7f8c8d;
        }
        
        #fileInput {
            display: none;
        }
        
        .browse-btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .browse-btn:hover {
            background-color: #2980b9;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            flex: 1;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .upload-options {
            margin-bottom: 20px;
        }
        
        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .option-row label {
            flex: 1;
            font-weight: 500;
        }
        
        .option-row input[type="number"] {
            width: 100px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar-inner {
            height: 100%;
            background-color: #2ecc71;
            width: 0%;
            transition: width 0.3s;
        }
        
        .chunks-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 15px 0;
        }
        
        .chunk {
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 3px;
        }
        
        .chunk.completed {
            background-color: #2ecc71;
        }
        
        .upload-result {
            background-color: #f1f9f1;
            border-left: 4px solid #2ecc71;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .error-message {
            background-color: #fff0f0;
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }
        
        .file-info {
            margin-top: 20px;
            display: none;
        }
        
        .file-info table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .file-info table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .file-info table td:first-child {
            font-weight: 500;
            width: 30%;
        }
        
        /* 已保存上传的样式 */
        .saved-uploads {
            margin-top: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            border: 1px solid #e9ecef;
            display: none;
        }
        
        .saved-uploads h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 18px;
        }
        
        .saved-uploads-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .saved-upload-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .saved-upload-item:last-child {
            border-bottom: none;
        }
        
        .saved-upload-info {
            flex: 1;
        }
        
        .saved-upload-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .saved-upload-progress {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .saved-upload-actions {
            display: flex;
            gap: 10px;
        }
        
        .saved-upload-resume {
            background-color: #27ae60;
            padding: 6px 12px;
        }
        
        .saved-upload-resume:hover {
            background-color: #219653;
        }
        
        .saved-upload-delete {
            background-color: #e74c3c;
            padding: 6px 12px;
        }
        
        .saved-upload-delete:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <h1>大文件上传与断点续传</h1>
    
    <div class="upload-container">
        <!-- 已保存的上传，会在有保存的上传任务时显示 -->
        <div class="saved-uploads" id="savedUploads">
            <h3>继续您未完成的上传</h3>
            <div class="saved-uploads-list" id="savedUploadsList">
                <!-- 已保存的上传项会在这里动态添加 -->
            </div>
        </div>
        
        <div class="file-input-container" id="dropZone">
            <p>拖放文件到这里，或</p>
            <label for="fileInput" class="browse-btn">浏览文件</label>
            <input type="file" id="fileInput">
        </div>
        
        <div class="file-info" id="fileInfo">
            <table>
                <tr>
                    <td>文件名:</td>
                    <td id="fileName"></td>
                </tr>
                <tr>
                    <td>文件大小:</td>
                    <td id="fileSize"></td>
                </tr>
                <tr>
                    <td>文件类型:</td>
                    <td id="fileType"></td>
                </tr>
            </table>
        </div>
        
        <div class="upload-options">
            <div class="option-row">
                <label for="chunkSize">分块大小 (MB):</label>
                <input type="number" id="chunkSize" value="5" min="1" max="20">
            </div>
        </div>
        
        <div class="controls">
            <button id="uploadBtn" disabled>开始上传</button>
            <button id="pauseBtn" disabled>暂停</button>
            <button id="resumeBtn" disabled>继续</button>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-info">
                <span id="uploadStatus">准备上传...</span>
                <span id="uploadPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-bar-inner" id="progressBar"></div>
            </div>
            <div class="chunks-grid" id="chunksGrid"></div>
            <div id="uploadSpeed"></div>
        </div>
        
        <div class="upload-result" id="uploadResult"></div>
        <div class="error-message" id="errorMessage"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const fileInput = document.getElementById('fileInput');
            const dropZone = document.querySelector('.file-input-container');
            const uploadBtn = document.getElementById('uploadBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const chunkSizeInput = document.getElementById('chunkSize');
            const parallelUploadsInput = document.getElementById('parallelUploads');
            const fileNameEl = document.getElementById('fileName');
            const fileSizeEl = document.getElementById('fileSize');
            const fileTypeEl = document.getElementById('fileType');
            const progressBar = document.querySelector('.progress-bar-inner');
            const uploadPercentage = document.getElementById('uploadPercentage');
            const uploadSpeed = document.getElementById('uploadSpeed');
            const uploadStatus = document.getElementById('uploadStatus');
            const chunksGrid = document.querySelector('.chunks-grid');
            const progressContainer = document.querySelector('.progress-container');
            const uploadResult = document.querySelector('.upload-result');
            const errorMessage = document.querySelector('.error-message');
            const fileInfo = document.querySelector('.file-info');
            const browseBtn = document.querySelector('.browse-btn');
            
            // WebSocket 连接
            let socket = null;
            
            // 上传状态变量
            let selectedFile = null;
            let chunkSize = 5 * 1024 * 1024; // 默认5MB
            let totalChunks = 0;
            let fileId = null;
            let uploadedChunks = [];
            let uploadQueue = [];
            let activeUploads = 0;
            let isUploading = false;
            let isPaused = false;
            let uploadStartTime = 0;
            let uploadedBytes = 0;
            
            // API基础URL
            const apiBaseUrl = '/file';
            
            // 初始化
            chunkSizeInput.value = 5; // 默认5MB
            parallelUploadsInput.value = 3; // 默认3个并行上传
            
            // 页面加载时检查是否有未完成的上传
            checkSavedUploads();
            
            // 在页面关闭/刷新前保存上传状态
            window.addEventListener('beforeunload', function() {
                // 如果正在上传且有文件ID，保存状态
                if ((isUploading || isPaused) && fileId && selectedFile) {
                    saveUploadState();
                }
            });
            
            // 文件选择事件处理
            fileInput.addEventListener('change', handleFileSelect);
            
            // 拖拽相关事件
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('dragover');
                }, false);
            });
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            // 分块大小改变事件
            chunkSizeInput.addEventListener('change', function() {
                if (selectedFile) {
                    calculateChunks();
                }
            });
            
            // 按钮事件
            uploadBtn.addEventListener('click', startUpload);
            pauseBtn.addEventListener('click', pauseUpload);
            resumeBtn.addEventListener('click', resumeUpload);
            
            // 检查本地存储中的上传记录
            function checkSavedUploads() {
                const uploads = getAllSavedUploads();
                
                if (Object.keys(uploads).length > 0) {
                    savedUploads.style.display = 'block';
                    savedUploadsList.innerHTML = '';
                    
                    for (const key in uploads) {
                        const uploadInfo = uploads[key];
                        addSavedUploadItem(uploadInfo);
                    }
                }
            }
            
            // 添加已保存的上传项到UI
            function addSavedUploadItem(uploadInfo) {
                const item = document.createElement('div');
                item.className = 'saved-upload-item';
                
                const completed = uploadInfo.uploadedChunks.length;
                const percentage = (completed / uploadInfo.totalChunks * 100).toFixed(1);
                
                item.innerHTML = `
                    <div class="saved-upload-info">
                        <div class="saved-upload-name">${uploadInfo.fileName}</div>
                        <div class="saved-upload-progress">进度: ${percentage}% (${formatFileSize(uploadInfo.fileSize)})</div>
                    </div>
                    <div class="saved-upload-actions">
                        <button class="saved-upload-resume">继续</button>
                        <button class="saved-upload-delete">删除</button>
                    </div>
                `;
                
                // 继续按钮事件
                const resumeBtn = item.querySelector('.saved-upload-resume');
                resumeBtn.addEventListener('click', () => {
                    resumeSavedUpload(uploadInfo);
                });
                
                // 删除按钮事件
                const deleteBtn = item.querySelector('.saved-upload-delete');
                deleteBtn.addEventListener('click', () => {
                    deleteSavedUpload(uploadInfo.fileId);
                    item.remove();
                    
                    // 如果没有保存的上传了，隐藏区域
                    if (savedUploadsList.children.length === 0) {
                        savedUploads.style.display = 'none';
                    }
                });
                
                savedUploadsList.appendChild(item);
            }
            
            // 恢复已保存的上传
            function resumeSavedUpload(uploadInfo) {
                // 提示用户选择相同的文件
                alert(`请选择相同的文件: ${uploadInfo.fileName}`);
                
                // 触发文件选择
                fileInput.click();
                
                // 处理文件选择后的操作
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    
                    if (!file) return;
                    
                    // 检查是否是相同的文件（名称和大小）
                    if (file.name === uploadInfo.fileName && file.size === uploadInfo.fileSize) {
                        selectedFile = file;
                        fileId = uploadInfo.fileId;
                        chunkSize = uploadInfo.chunkSize;
                        totalChunks = uploadInfo.totalChunks;
                        uploadedChunks = [...uploadInfo.uploadedChunks];
                        
                        // 设置块大小输入
                        chunkSizeInput.value = chunkSize / (1024 * 1024);
                        
                        // 显示文件信息
                        displayFileInfo();
                        createChunksGrid();
                        
                        // 更新UI状态
                        progressContainer.style.display = 'block';
                        updateProgress(uploadedChunks.length, totalChunks);
                        uploadBtn.disabled = false;
                        
                        // 准备继续上传
                        resumeUploadFromSaved();
                    } else {
                        alert('选择的文件与之前上传的文件不匹配！');
                        resetUploadState();
                    }
                    
                    // 重置onchange处理函数
                    fileInput.onchange = handleFileSelect;
                };
            }
            
            // 从已保存状态继续上传
            function resumeUploadFromSaved() {
                if (isUploading || !selectedFile || !fileId) return;
                
                isUploading = true;
                isPaused = false;
                uploadQueue = [];
                activeUploads = 0;
                uploadStartTime = Date.now();
                uploadedBytes = 0;
                
                // 更新UI
                uploadStatus.textContent = '正在上传...';
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                uploadBtn.disabled = true;
                
                // 准备上传队列（跳过已上传的分块）
                for (let i = 0; i < totalChunks; i++) {
                    if (!uploadedChunks.includes(i)) {
                        uploadQueue.push(i);
                    }
                }
                
                // 没有需要上传的分块，直接完成
                if (uploadQueue.length === 0) {
                    completeUpload();
                    return;
                }
                
                // 开始上传分块
                processQueue();
            }
            
            // 保存上传状态到本地存储
            function saveUploadState() {
                if (!fileId || !selectedFile) return;
                
                const uploadInfo = {
                    fileId: fileId,
                    fileName: selectedFile.name,
                    fileSize: selectedFile.size,
                    fileType: selectedFile.type,
                    chunkSize: chunkSize,
                    totalChunks: totalChunks,
                    uploadedChunks: uploadedChunks,
                    lastUpdated: Date.now()
                };
                
                // 获取所有保存的上传
                const savedUploads = getAllSavedUploads();
                
                // 更新当前上传
                savedUploads[fileId] = uploadInfo;
                
                // 保存到本地存储
                localStorage.setItem('savedUploads', JSON.stringify(savedUploads));
            }
            
            // 获取所有保存的上传
            function getAllSavedUploads() {
                const uploadsJson = localStorage.getItem('savedUploads');
                return uploadsJson ? JSON.parse(uploadsJson) : {};
            }
            
            // 删除保存的上传
            function deleteSavedUpload(fileId) {
                const savedUploads = getAllSavedUploads();
                
                if (savedUploads[fileId]) {
                    delete savedUploads[fileId];
                    localStorage.setItem('savedUploads', JSON.stringify(savedUploads));
                }
            }
            
            // 处理文件选择
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    selectedFile = file;
                    displayFileInfo();
                    calculateChunks();
                    resetUploadState();
                    uploadBtn.disabled = false;
                }
            }
            
            // 处理文件拖放
            function handleDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file) {
                    selectedFile = file;
                    displayFileInfo();
                    calculateChunks();
                    resetUploadState();
                    uploadBtn.disabled = false;
                }
            }
            
            // 显示文件信息
            function displayFileInfo() {
                fileNameEl.textContent = selectedFile.name;
                fileSizeEl.textContent = formatFileSize(selectedFile.size);
                fileTypeEl.textContent = selectedFile.type || "未知";
                fileInfo.style.display = 'block';
            }
            
            // 格式化文件大小
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 计算分块数量
            function calculateChunks() {
                chunkSize = parseInt(chunkSizeInput.value) * 1024 * 1024; // 转换为字节
                totalChunks = Math.ceil(selectedFile.size / chunkSize);
                
                // 生成分块显示
                createChunksGrid();
            }
            
            // 创建分块网格显示
            function createChunksGrid() {
                chunksGrid.innerHTML = '';
                chunksGrid.style.gridTemplateColumns = `repeat(${Math.min(10, totalChunks)}, 1fr)`;
                
                for (let i = 0; i < totalChunks; i++) {
                    const chunk = document.createElement('div');
                    chunk.className = 'chunk';
                    chunk.dataset.index = i;
                    chunksGrid.appendChild(chunk);
                }
            }
            
            // 重置上传状态
            function resetUploadState() {
                fileId = null;
                uploadedChunks = [];
                isUploading = false;
                isPaused = false;
                progressBar.style.width = '0%';
                uploadStatus.textContent = '准备上传...';
                uploadPercentage.textContent = '0%';
                uploadResult.style.display = 'none';
                errorMessage.style.display = 'none';
                progressContainer.style.display = 'none';
                uploadSpeed.textContent = '';
                
                // 关闭WebSocket连接
                closeWebSocket();
            }
            
            // 尝试建立WebSocket连接
            function connectWebSocket(fileId) {
                if (!fileId) return;
                
                // 关闭已有连接
                if (socket) {
                    socket.close();
                    socket = null;
                }
                
                // 创建新连接
                socket = new WebSocket(`ws://${window.location.host}/socket/upload/${fileId}`);
                
                socket.onopen = function() {
                    console.log('WebSocket连接已建立');
                };
                
                socket.onclose = function() {
                    console.log('WebSocket连接已关闭');
                    socket = null;
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocket错误:', error);
                };
                
                socket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('收到WebSocket消息:', data);
                        
                        switch (data.event) {
                            case 'init':
                            case 'progress':
                                // 更新上传进度
                                uploadedChunks = Array.from({ length: data.completed }, (_, i) => i);
                                updateProgress(data.completed, data.totalChunks);
                                break;
                            case 'complete':
                                // 上传完成
                                showUploadResult(data.fileName, data.fileSize);
                                break;
                        }
                    } catch (error) {
                        console.error('处理WebSocket消息时出错:', error);
                    }
                };
            }
            
            // 关闭WebSocket连接
            function closeWebSocket() {
                if (socket) {
                    socket.close();
                    socket = null;
                }
            }
            
            // 开始上传
            async function startUpload() {
                if (!selectedFile || isUploading) return;
                
                isUploading = true;
                isPaused = false;
                uploadedChunks = [];
                uploadQueue = [];
                activeUploads = 0;
                uploadStartTime = Date.now();
                uploadedBytes = 0;
                
                // 显示进度容器
                progressContainer.style.display = 'block';
                uploadStatus.textContent = '初始化上传...';
                
                // 禁用上传按钮，启用暂停按钮
                uploadBtn.disabled = true;
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                
                try {
                    // 初始化上传
                    await initializeUpload();
                    
                    // 如果初始化成功且未暂停，开始上传分块
                    if (fileId && !isPaused) {
                        uploadStatus.textContent = '正在上传...';
                        
                        // 准备上传队列
                        for (let i = 0; i < totalChunks; i++) {
                            if (!uploadedChunks.includes(i)) {
                                uploadQueue.push(i);
                            }
                        }
                        
                        // 开始上传分块
                        processQueue();
                    }
                } catch (error) {
                    showError('上传初始化失败: ' + error.message);
                    resetUpload();
                }
            }
            
            // 初始化上传任务
            async function initializeUpload() {
                const formData = new FormData();
                formData.append('fileName', selectedFile.name);
                formData.append('fileSize', selectedFile.size);
                formData.append('chunkSize', chunkSize);
                
                const response = await fetch(`${apiBaseUrl}/upload/init`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`服务器返回错误: ${response.status}`);
                }
                
                const data = await response.json();
                fileId = data.fileId;
                
                // 建立WebSocket连接
                connectWebSocket(fileId);
                
                // 如果是恢复上传，标记已上传的分块
                if (data.resumed && data.completed > 0) {
                    // 查询已上传的分块状态
                    await checkUploadStatus();
                }
                
                return data;
            }
            
            // 查询上传状态
            async function checkUploadStatus() {
                try {
                    const response = await fetch(`${apiBaseUrl}/upload/status?fileID=${fileId}`);
                    
                    if (!response.ok) {
                        throw new Error(`服务器返回错误: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // 更新进度
                    updateProgress(data.completed, data.totalChunks);
                    
                    return data;
                } catch (error) {
                    console.error('获取上传状态失败:', error);
                    throw error;
                }
            }
            
            // 更新上传进度
            function updateProgress(completed, total) {
                const percentage = (completed / total * 100).toFixed(1);
                progressBar.style.width = percentage + '%';
                uploadPercentage.textContent = percentage + '%';
                
                // 更新分块显示
                const chunks = document.querySelectorAll('.chunk');
                for (let i = 0; i < uploadedChunks.length; i++) {
                    const chunkIndex = uploadedChunks[i];
                    const chunkEl = document.querySelector(`.chunk[data-index="${chunkIndex}"]`);
                    if (chunkEl) {
                        chunkEl.classList.add('completed');
                    }
                }
                
                // 计算上传速度
                const elapsedTime = (Date.now() - uploadStartTime) / 1000; // 秒
                if (elapsedTime > 0) {
                    const bytesPerSecond = uploadedBytes / elapsedTime;
                    let speedText = '';
                    
                    if (bytesPerSecond < 1024) {
                        speedText = bytesPerSecond.toFixed(1) + ' B/s';
                    } else if (bytesPerSecond < 1024 * 1024) {
                        speedText = (bytesPerSecond / 1024).toFixed(1) + ' KB/s';
                    } else {
                        speedText = (bytesPerSecond / (1024 * 1024)).toFixed(1) + ' MB/s';
                    }
                    
                    uploadSpeed.textContent = `上传速度: ${speedText} | 已完成: ${completed}/${total}`;
                }
            }
            
            // 显示错误信息
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            }
            
            // 重置上传控件状态
            function resetUpload() {
                isUploading = false;
                isPaused = false;
                uploadBtn.disabled = false;
                pauseBtn.disabled = true;
                resumeBtn.disabled = true;
            }
            
            // 暂停上传
            function pauseUpload() {
                if (isUploading) {
                    isPaused = true;
                    uploadStatus.textContent = '已暂停';
                    pauseBtn.disabled = true;
                    resumeBtn.disabled = false;
                    
                    // 保存上传状态到本地存储
                    saveUploadState();
                }
            }
            
            // 恢复上传
            function resumeUpload() {
                if (isPaused) {
                    isPaused = false;
                    isUploading = true;
                    uploadStatus.textContent = '正在上传...';
                    pauseBtn.disabled = false;
                    resumeBtn.disabled = true;
                    
                    // 继续处理队列
                    processQueue();
                }
            }
            
            // 处理上传队列
            function processQueue() {
                if (isPaused || !isUploading) return;
                
                // 填充并发上传槽
                while (activeUploads < parallelUploadsInput.value && uploadQueue.length > 0) {
                    const chunkIndex = uploadQueue.shift();
                    uploadChunk(chunkIndex);
                    activeUploads++;
                }
                
                // 如果队列为空且没有活跃上传，则表示上传完成
                if (uploadQueue.length === 0 && activeUploads === 0) {
                    completeUpload();
                }
            }
            
            // 上传单个分块
            async function uploadChunk(chunkIndex) {
                if (isPaused || !isUploading) {
                    activeUploads--;
                    return;
                }
                
                try {
                    // 计算分块范围
                    const start = chunkIndex * chunkSize;
                    const end = Math.min(start + chunkSize, selectedFile.size);
                    const chunk = selectedFile.slice(start, end);
                    
                    // 创建 FormData
                    const formData = new FormData();
                    formData.append('fileID', fileId);
                    formData.append('chunkIndex', chunkIndex);
                    formData.append('chunk', chunk, 'chunk');
                    
                    // 发送请求
                    const response = await fetch(`${apiBaseUrl}/upload/chunk`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!isPaused) {
                        if (response.ok) {
                            const data = await response.json();
                            
                            // 标记分块为已完成
                            if (!uploadedChunks.includes(chunkIndex)) {
                                uploadedChunks.push(chunkIndex);
                                
                                // 更新上传进度
                                updateProgress(uploadedChunks.length, totalChunks);
                                
                                // 更新已上传字节数（用于计算速度）
                                uploadedBytes += (end - start);
                                
                                // 更新分块状态显示
                                const chunkEl = document.querySelector(`.chunk[data-index="${chunkIndex}"]`);
                                if (chunkEl) {
                                    chunkEl.classList.add('completed');
                                }
                                
                                // 保存上传状态到本地存储
                                saveUploadState();
                            }
                        } else {
                            // 上传失败，将分块放回队列
                            const errorData = await response.json();
                            console.error(`分块 ${chunkIndex} 上传失败:`, errorData);
                            uploadQueue.push(chunkIndex);
                        }
                    }
                } catch (error) {
                    console.error(`分块 ${chunkIndex} 上传出错:`, error);
                    // 上传出错，将分块放回队列
                    if (isUploading && !isPaused) {
                        uploadQueue.push(chunkIndex);
                    }
                } finally {
                    // 减少活跃上传计数
                    activeUploads--;
                    
                    // 继续处理队列
                    if (isUploading && !isPaused) {
                        processQueue();
                    }
                }
            }
            
            // 完成上传
            async function completeUpload() {
                try {
                    uploadStatus.textContent = '正在完成上传...';
                    
                    const formData = new FormData();
                    formData.append('fileID', fileId);
                    
                    const response = await fetch(`${apiBaseUrl}/upload/complete`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`服务器返回错误: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // 显示上传成功
                    showUploadResult(data.fileName, data.fileSize);
                    
                    // 清除本地保存的上传状态
                    deleteSavedUpload(fileId);
                    
                    // 关闭WebSocket连接
                    closeWebSocket();
                    
                } catch (error) {
                    showError('完成上传失败: ' + error.message);
                } finally {
                    resetUpload();
                }
            }
            
            // 取消上传
            function cancelUpload() {
                if (fileId) {
                    // 关闭WebSocket连接
                    closeWebSocket();
                    
                    // 删除保存的上传记录
                    deleteSavedUpload(fileId);
                }
                
                resetUpload();
                uploadStatus.textContent = '上传已取消';
            }
        });
    </script>
</body>
</html> 